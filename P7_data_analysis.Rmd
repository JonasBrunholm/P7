---
title: "P7_Data_analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
Sys.setenv(language = "en")

library(tidyquant)
library(tidyverse)

library(tseries)
library(forecast)

# devtools::install_github("itamarcaspi/rtadfr")

# library(rtadfr)

# library(styler)
```



# forsøg på selv at generere DF fordeling

```{r}


DF_distri <- function(T_val = 100, seed = 12345, sd_rv = 1, y_0 = 1, n_monte = 10) {
  set.seed(seed)
  t_vector <- c()
  list_t_greater_0 <- list()
  # k <- 1

  for (j in 1:n_monte) {
    y <- c()
    y[1] <- y_0
    y_fin <- c()

    for (i in 2:(T_val + T_val / 2)) {
      eps <- rnorm(1, mean = 0, sd = sd_rv)
      y[i] <- y[i - 1] + eps
      y_fin <- y[((T_val / 2) + 1):(T_val + T_val / 2)]
    }
    data <- tibble()
    data <- tibble(
      t = 1:T_val,
      y = y_fin
    )
    model <- list()
    model <- lm(diff(y) ~ lag(y)[2:T_val], data = data)

    # if (coef(model)[2] > 0) {
    #   list_t_greater_0[[k]] <- list(
    #     y = data$y,
    #     model = summary(model),
    #     t_val = summary(model)$coefficients[2, 3]
    #   )
    #   k <- k + 1
    # }

    t_vector[j] <- summary(model)$coefficients[2, 3]
  }

  t_95 <- sort(t_vector, decreasing = T)[n_monte * 0.95]
  t_99 <- sort(t_vector, decreasing = T)[n_monte * 0.99]

  list_return <- list(
    t_vector = t_vector,
    quantile_95 = t_95,
    quantile_99 = t_99,
    list_0 = list_t_greater_0
  )
  return(list_return)
}

# df_distr_test <- DF_distri(T_val = 50, n_monte = 10000)


# ggplot(data.frame(y = df_distr_test$t_vector), aes(y)) +
  # geom_density()
# df_distr_test$quantile_95
# df_distr_test$quantile_99


```

```{r}

index_T <- seq(from = 20, to = 2000, by = 10)
df_distri_list <- list()
for (i in 1:length(index_T)) {
  df_distri_list[[i]] <- DF_distri(T_val = index_T[i], n_monte = 1000)
}


tibble_distri <- tibble(.rows = 1000)
col_name <- c()

for (i in 1:length(index_T)) {
  col_name[i] <- paste("T", index_T[i], sep = "_")
  tibble_distri <- bind_cols(tibble_distri, df_distri_list[[i]]["t_vector"])
}

colnames(tibble_distri) <- col_name
```



```{r}

Bitcoin_data <- tq_get(x = "btc-usd", get = "stock.prices", from = "0000-01-01")
btc <- na.omit(Bitcoin_data$close)

# test_adf <- adf.test(Bitcoin_data$close %>% na.omit(), k = 0, alternative = "stationary")

plot.ts(Bitcoin_data$close)



GSADF_fun <- function(x, min_window, step_length, window_increase) {
  nrow_x <- length(x)
  window_size <- min_window
  
  result <- tibble()
  k_ind <- 1
  while(window_size < (nrow_x- step_length)) {
    max_i <- floor((nrow_x - window_size)/step_length)
    for (i in 0:max_i) {
    adf_list <- suppressWarnings(adf.test(x = x[(step_length*i):((step_length*i) + window_size)],
                              alternative = "stationary",
                              k = 0))
    result[k_ind, "t_value"] <- adf_list[["statistic"]][["Dickey-Fuller"]]
    result[k_ind, "start_day"] <- step_length*i
    result[k_ind, "end_day"] <- ((step_length*i) + window_size)
    result[k_ind, "interval_length"] <- window_size
    k_ind <- k_ind + 1
    }
    window_size <- window_size + window_increase
  }
  result
}

GSADF_fun_result <- GSADF_fun(x = btc, min_window = 30, step_length = 5, window_increase = 10)

max_pr_gruppe <- GSADF_fun_result %>% group_by(interval_length) %>%
  summarise(max_t_group = max(t_value)) %>%
  select(max_t_group)

p_vals <- tibble()
for (i in 1:ncol(tibble_distri)-1) {
  p_vals[i,1] <- sum(max_pr_gruppe[i,1] %>% pull() > tibble_distri[,i+1])/nrow(tibble_distri)
}


```
